name: Build

on:
  push:
    tags:
    - "v*.*.*"
  workflow_call:
    inputs:
      tags:
        required: false
        type: string
        description: "Tags to push, separated by return line. If not provided, it will be extracted from git tag"
  workflow_dispatch:
    inputs:
      custom_tags:
        required: false
        type: string
        description: "Tags to push, separated by return line. If not provided, it will be extracted from git tag"

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.get_version.outputs.tags }}
      shell_image_tag: ${{ steps.get_shell_tags.outputs.tags }}
    permissions:
      packages: write
    steps:
    - uses: actions/checkout@v4
    - uses: docker/setup-qemu-action@v3
    - uses: docker/setup-buildx-action@v3
    - uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Extract version
      id: get_version
      run: |
        OWNER_LOWER=$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')
        if [ -n "${{  inputs.custom_tags }}" ]; then
          echo "Using provided custom tags"
          TAGS=$(echo "ghcr.io/${OWNER_LOWER}/claim-controller:${{ inputs.custom_tags }}")
          echo "tags<<EOF" >> "$GITHUB_OUTPUT"
          echo "$TAGS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
        elif [ -z "${{ inputs.tags }}" ]; then
          echo "No tags provided, extracting from git tag"
          VERSION="${GITHUB_REF_NAME#v}"
          MAJOR="ghcr.io/${OWNER_LOWER}/claim-controller:$(echo $VERSION | cut -d. -f1)"
          MINOR="ghcr.io/${OWNER_LOWER}/claim-controller:$(echo $VERSION | cut -d. -f1,2)"
          PATCH="ghcr.io/${OWNER_LOWER}/claim-controller:$(echo $VERSION)"
          echo "tags<<EOF" >> "$GITHUB_OUTPUT"
          echo "$MAJOR" >> "$GITHUB_OUTPUT"
          echo "$MINOR" >> "$GITHUB_OUTPUT"
          echo "$PATCH" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
        else
          echo "Using provided tags"
          TAGS=$(echo "${{ inputs.tags }}")
          echo "tags<<EOF" >> "$GITHUB_OUTPUT"
          echo "$TAGS" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
        fi
    - name: Derive shell tags
      id: get_shell_tags
      run: |
        echo "tags<<EOF" >> "$GITHUB_OUTPUT"
        while IFS= read -r tag; do
          [ -z "$tag" ] && continue
          echo "${tag}-shell" >> "$GITHUB_OUTPUT"
        done <<< "${{ steps.get_version.outputs.tags }}"
        echo "EOF" >> "$GITHUB_OUTPUT"

    - name: Build and push prod
      uses: docker/build-push-action@v6
      with:
        push: true
        pull: true
        target: prod
        tags: ${{ steps.get_version.outputs.tags }}

    - name: Build and push prod-shell
      uses: docker/build-push-action@v6
      with:
        push: true
        pull: true
        target: prod-shell
        tags: ${{ steps.get_shell_tags.outputs.tags }}
